# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

AstroSimは太陽系の惑星公転シミュレーションアプリケーションです：
- 太陽系の惑星の公転をシミュレーション
- 各惑星を3D表現で表示
- インタラクティブ機能（惑星をクリックして情報表示）
- Pythonで実装

## 現在のプロジェクト状況

### 完了したフェーズ

#### 計画フェーズ（完了）
1. ✅ **要件分析と技術調査** - 機能要件、非機能要件の詳細分析完了
2. ✅ **システムアーキテクチャの検討** - レイヤードアーキテクチャ + MVPパターン採用決定
3. ✅ **技術選定** - Vispy（3D）、PyQt6（GUI）、HDF5+JSON（データ）選定
4. ✅ **開発スケジュール策定** - 12週間の開発計画、5つのマイルストーン設定
5. ✅ **概要設計書作成** - docs/概要設計書.md 作成完了

#### 設計フェーズ（完了）
1. ✅ **詳細設計書作成** - docs/詳細設計書.md 作成完了
   - 全モジュールの詳細仕様定義
   - クラス設計とインターフェース定義
   - エラー処理とロギング設計
2. ✅ **テスト計画策定** - docs/テスト計画書.md 作成完了
   - TDDアプローチの詳細計画
   - 単体/統合/システム/パフォーマンステストの設計
   - 品質基準とメトリクスの定義

#### テスト設計フェーズ（完了）
1. ✅ **テストフレームワークのセットアップ** - pytest環境構築完了
   - requirements.txt, requirements-dev.txt作成
   - pytest.ini設定ファイル作成
2. ✅ **テストディレクトリ構造の作成** - 体系的なテスト構造完成
   - tests/unit/, tests/integration/, tests/performance/
   - モジュール別テストディレクトリ構造
3. ✅ **conftest.pyの作成** - 共通テストフィクスチャ定義
   - 惑星データ、軌道要素、テスト用ヘルパー関数
   - カスタムアサーション、数学的定数
4. ✅ **ドメインモデル層のテスト作成** - 完全なテストカバレッジ
   - OrbitalElements, CelestialBody, Planet, SolarSystemのテスト
   - 物理法則の検証、エッジケース処理
5. ✅ **シミュレーション層のテスト作成** - 物理計算の正確性検証
   - PhysicsEngine, TimeManager, OrbitCalculatorのテスト
   - エネルギー保存、運動量保存、軌道周期の検証
6. ✅ **モックオブジェクトの準備** - 外部依存の最小限モック化
   - 3Dレンダリング（Vispy）、GUI（PyQt6）、ファイルI/Oのモック

#### 実装フェーズ（進行中）
1. ✅ **基本プロジェクト構造の作成** - src/ディレクトリ構造完成
   - src/ディレクトリ構造の作成完了
   - __init__.pyファイルの配置完了
2. ✅ **ドメインモデル層の実装** - 完全実装完了
   - OrbitalElements: 軌道要素の管理とケプラー計算
   - CelestialBody: 天体基底クラス（質量、半径、位置、速度）
   - Planet: 惑星クラス（軌道運動、Kepler方程式解法）
   - Sun: 太陽クラス（光源特性、固定位置）
   - SolarSystem: 太陽系管理（天体追加、位置更新、物理量計算）
3. ✅ **シミュレーション層の実装** - 完全実装完了
   - PhysicsEngine: 重力計算、N体問題数値積分（RK4法）、ケプラー方程式解法
   - TimeManager: 時間制御、ユリウス日変換、時間倍率制御
   - OrbitCalculator: 軌道要素↔位置速度変換、軌道分析
4. ✅ **可視化層の実装** - 完全実装完了
   - Renderer3D: Vispy使用の3Dレンダリング（太陽・惑星描画、軌道線、選択表示）
   - CameraController: カメラ制御（回転、ズーム、パン、フォーカス、追跡）
   - SceneManager: 3Dシーン管理（アニメーション、イベント処理、表示設定）

### 現在のフェーズ：実装フェーズ（継続）

### 実装済み機能の検証
- ✅ **全レイヤーの単体テスト実行** - 6/6テスト成功
  - 物理計算の正確性確認（地球軌道周期365.26日、太陽脱出速度617.8km/s）
  - ケプラー軌道計算の精度検証
  - 3D座標変換の動作確認

### 次のタスク
1. **UI層の実装**
   - MainWindow: PyQt6メインウィンドウ
   - ControlPanel: シミュレーション制御パネル
   - InfoPanel: 天体情報表示パネル
2. **データ層の実装**
   - Repository: データ永続化
   - DataLoader: 惑星データ読み込み（JSON/HDF5）
3. **統合テストとMVP完成**
   - 全レイヤー統合
   - エンドツーエンドテスト

### 今後の開発フェーズ
1. **実装フェーズ** - MVP機能の実装（現在）
2. **検証フェーズ** - テスト実行、品質保証

## 開発セットアップ

1. 仮想環境の作成：
   ```bash
   python -m venv venv
   venv\Scripts\activate  # Windows環境
   ```

2. 依存関係のインストール（requirements.txt作成後）：
   ```bash
   pip install -r requirements.txt
   ```

3. 主要な依存関係（予定）：
   ```
   vispy>=0.14.0          # 3Dビジュアライゼーション
   PyQt6>=6.5.0           # GUIフレームワーク
   numpy>=1.24.0          # 数値計算
   scipy>=1.10.0          # 科学計算
   astropy>=5.3.0         # 天文学計算
   h5py>=3.9.0            # HDF5サポート
   pytest>=7.4.0          # テスト
   black>=23.0.0          # コードフォーマッター
   flake8>=6.0.0          # リンター
   mypy>=1.5.0            # 型チェック
   numba>=0.57.0          # JITコンパイル（オプション）
   ```

## 開発コマンド

```bash
# テストの実行
python -m pytest tests/

# カバレッジ付きテスト実行
python -m pytest --cov=src tests/

# 特定のテストファイルの実行
python -m pytest tests/test_simulation.py

# リントチェック
python -m flake8 src/
python -m mypy src/

# アプリケーションの実行
python src/main.py
```

## 採用した技術スタック

計画フェーズで決定した技術スタック：
- **3Dグラフィックスライブラリ**: Vispy（科学的可視化に特化、GPU効率的）
- **GUIフレームワーク**: PyQt6（プロフェッショナルUI、OpenGL統合）
- **科学計算**: NumPy, SciPy, Astropy（天文学専用ライブラリ）
- **データ形式**: HDF5（大規模データ）+ JSON（設定ファイル）
- **テストフレームワーク**: pytest
- **開発ツール**: black（フォーマッター）、flake8（リンター）、mypy（型チェック）

## 実装済みプロジェクト構造

```
AstroSim/
├── docs/                          # 設計ドキュメント
│   ├── 概要設計書.md              # システム全体の設計
│   ├── 詳細設計書.md              # 各モジュールの詳細設計
│   └── テスト計画書.md            # TDDテスト計画
├── src/                           # ソースコード
│   ├── domain/                    # ドメインモデル層 ✅
│   │   ├── __init__.py
│   │   ├── orbital_elements.py    # 軌道要素クラス
│   │   ├── celestial_body.py      # 天体基底クラス
│   │   ├── planet.py              # 惑星クラス
│   │   ├── sun.py                 # 太陽クラス
│   │   └── solar_system.py        # 太陽系管理クラス
│   ├── simulation/                # シミュレーション層 ✅
│   │   ├── __init__.py
│   │   ├── physics_engine.py      # 物理エンジン
│   │   ├── time_manager.py        # 時間管理
│   │   └── orbit_calculator.py    # 軌道計算
│   ├── visualization/             # 可視化層 ✅
│   │   ├── __init__.py
│   │   ├── renderer_3d.py         # 3Dレンダラー
│   │   ├── camera_controller.py   # カメラ制御
│   │   └── scene_manager.py       # シーン管理
│   ├── ui/                        # UI層 🔄
│   │   └── __init__.py
│   └── data/                      # データ層 ⏳
│       └── __init__.py
├── tests/                         # テストコード ✅
│   ├── conftest.py                # 共通フィクスチャ
│   └── unit/                      # 単体テスト
│       ├── domain/                # ドメイン層テスト
│       └── simulation/            # シミュレーション層テスト
├── test_manual.py                 # 手動テストスクリプト ✅
├── requirements.txt               # 基本依存関係
├── requirements-dev.txt           # 開発依存関係
├── pytest.ini                    # テスト設定
└── CLAUDE.md                     # プロジェクト管理ドキュメント
```

**凡例**: ✅完了 🔄進行中 ⏳未着手

## 開発ルール

### 開発プロセス

1. **設計優先アプローチ**:
   - 実装前に必ず開発計画を十分に検討する（think hard）
   - 概要設計書（docs/概要設計書.md）を作成
   - 詳細設計書（docs/詳細設計書.md）を作成
   - 設計レビューを行ってから実装に着手

2. **テスト駆動開発（TDD）**:
   - 機能実装前に必ずテストを設計・実装
   - テストがパスしてから次のステップに進む
   - 各モジュールに対応するテストファイルを作成
   - カバレッジ目標: 80%以上
   - **モックの使用は最小限に**: 実際のオブジェクトを使ったテストを優先し、外部依存（ファイルI/O、ネットワーク、GUI）のみモック使用

### コーディング規約

1. **ドキュメント言語**: すべてのドキュメント、コメント、コミットメッセージは日本語で記述する
2. **命名規則**: 
   - 変数名・関数名: 英語（snake_case）
   - クラス名: 英語（PascalCase）
   - ファイル名: 英語（snake_case）
3. **コメント**: 重要なロジックには日本語でコメントを追加
4. **エラーメッセージ**: ユーザー向けメッセージは日本語で表示
5. **Gitコミット**: コミットメッセージは日本語で記述し、変更内容と理由を明確に記載する

## 開発ワークフロー

新機能を実装する際の標準的な流れ：

1. **計画フェーズ**
   - 要件を十分に理解し、実装方針を検討
   - TodoWriteツールで実装タスクを整理

2. **設計フェーズ**
   - 概要設計書で全体アーキテクチャを定義
   - 詳細設計書で各モジュールのインターフェースを定義
   - クラス図、シーケンス図などのUMLを活用

3. **テスト設計フェーズ**
   - 各機能のテストケースを先に作成
   - テストファイルを実装（最初は全て失敗する状態）

4. **実装フェーズ**
   - テストがパスするように機能を実装
   - リファクタリングでコード品質を改善

5. **検証フェーズ**
   - 全テストの実行
   - リントツールでコード品質チェック
   - ドキュメントの更新

### フェーズ移行時の必須作業

**重要**: 各フェーズの作業が完了したら、次のフェーズに進む前に必ずCLAUDE.mdを更新すること：
- 完了したフェーズの成果物と状況を「現在のプロジェクト状況」セクションに反映
- 次のフェーズのタスクを明確に記載
- 技術的な決定事項や変更があれば関連セクションも更新
- これにより、プロジェクトの進捗が常に最新状態で把握可能

## 重要な考慮事項

- **軌道力学**: ケプラーの法則を初期実装、将来的にN体シミュレーション対応
- **パフォーマンス**: NumPyベクトル計算とVispyのGPU活用で高速化
- **インタラクティビティ**: Vispyのレイキャスティング機能で惑星選択実装
- **スケール**: 惑星サイズは対数スケール、軌道は実スケール/圧縮スケール切替可能

## 設計ドキュメント

- **概要設計書** (`docs/概要設計書.md`): システム全体のアーキテクチャ、主要機能、技術スタックを定義
- **詳細設計書** (`docs/詳細設計書.md`): 各モジュールの詳細仕様、インターフェース定義
- **テスト計画書** (`docs/テスト計画書.md`): TDDアプローチ、テストケース設計、品質基準

## 開発マイルストーン

1. ✅ **M1（週3）**: 基本アーキテクチャ完成
   - ドメインモデル層、シミュレーション層、可視化層の実装完了
   - 物理計算エンジンの動作確認
2. 🔄 **M2（週5）**: 物理シミュレーション動作
   - UI層の実装（進行中）
   - データ層の実装
3. ⏳ **M3（週7）**: 3D表示機能完成（MVP達成）
   - 全レイヤー統合
   - エンドツーエンドテスト
4. ⏳ **M4（週10）**: 全機能統合完了
5. ⏳ **M5（週12）**: リリース準備完了

**現在の進捗**: M1完了、M2進行中（UI層実装フェーズ）