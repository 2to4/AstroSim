# AstroSim 詳細設計書

## 1. はじめに

本書は、AstroSim太陽系シミュレーションアプリケーションの詳細設計を記述したものです。概要設計書で定義されたアーキテクチャに基づき、各モジュールの詳細な仕様とインターフェースを定義します。

## 2. モジュール構成

### 2.1 パッケージ構造

```
src/
├── __init__.py
├── main.py                    # アプリケーションエントリーポイント
├── core/                      # コアシステム層
│   ├── __init__.py
│   ├── application.py         # アプリケーション管理
│   ├── event_system.py        # イベントシステム
│   ├── command.py             # コマンドパターン
│   └── constants.py           # システム定数
│
├── domain/                    # ドメインモデル層
│   ├── __init__.py
│   ├── celestial_body.py      # 天体基底クラス
│   ├── planet.py              # 惑星クラス
│   ├── sun.py                 # 太陽クラス
│   ├── solar_system.py        # 太陽系クラス
│   └── orbital_elements.py    # 軌道要素
│
├── simulation/                # シミュレーション層
│   ├── __init__.py
│   ├── physics_engine.py      # 物理エンジン
│   ├── orbit_calculator.py    # 軌道計算
│   ├── time_manager.py        # 時間管理
│   └── simulation_state.py    # 状態管理
│
├── visualization/             # 可視化層
│   ├── __init__.py
│   ├── renderer.py            # メインレンダラー
│   ├── scene_manager.py       # シーン管理
│   ├── camera.py              # カメラ制御
│   ├── planet_renderer.py     # 惑星レンダリング
│   └── shaders/               # シェーダープログラム
│       ├── __init__.py
│       ├── planet_vertex.glsl
│       └── planet_fragment.glsl
│
├── ui/                        # UI層
│   ├── __init__.py
│   ├── main_window.py         # メインウィンドウ
│   ├── control_panel.py       # コントロールパネル
│   ├── info_panel.py          # 情報パネル
│   ├── time_control.py        # 時間制御UI
│   └── styles/                # UIスタイル定義
│       └── dark_theme.qss
│
├── data/                      # データ層
│   ├── __init__.py
│   ├── repository.py          # データリポジトリ
│   ├── data_loader.py         # データローダー
│   ├── planet_data.json       # 惑星データ
│   └── config.json            # 設定ファイル
│
└── utils/                     # ユーティリティ
    ├── __init__.py
    ├── math_helpers.py        # 数学関数
    ├── vector3.py             # 3Dベクトルクラス
    └── logger.py              # ロギング
```

## 3. コアシステム層（core）

### 3.1 Application クラス

```python
from typing import Optional
from PyQt6.QtWidgets import QApplication
from vispy.app import Application as VispyApp

class Application:
    """
    アプリケーション全体を管理するクラス
    """
    
    def __init__(self):
        self.qt_app: Optional[QApplication] = None
        self.vispy_app: Optional[VispyApp] = None
        self.main_window: Optional[MainWindow] = None
        self.simulation_controller: Optional[SimulationController] = None
        self.renderer: Optional[Renderer3D] = None
        self.event_bus: EventBus = EventBus()
        
    def initialize(self) -> None:
        """アプリケーションの初期化"""
        # Qt アプリケーションの初期化
        # Vispy の初期化
        # 各コンポーネントの生成と接続
        
    def run(self) -> int:
        """アプリケーションのメインループ実行"""
        # Qt イベントループの開始
        
    def shutdown(self) -> None:
        """アプリケーションの終了処理"""
        # リソースの解放
```

### 3.2 EventSystem クラス

```python
from typing import Dict, List, Callable, Any
from dataclasses import dataclass
from enum import Enum

class EventType(Enum):
    """イベントタイプの定義"""
    PLANET_SELECTED = "planet_selected"
    TIME_CHANGED = "time_changed"
    CAMERA_MOVED = "camera_moved"
    SIMULATION_PAUSED = "simulation_paused"
    SIMULATION_RESUMED = "simulation_resumed"

@dataclass
class Event:
    """イベントデータクラス"""
    type: EventType
    data: Dict[str, Any]
    timestamp: float

class EventBus:
    """
    アプリケーション全体のイベント管理
    """
    
    def __init__(self):
        self._handlers: Dict[EventType, List[Callable]] = {}
        
    def subscribe(self, event_type: EventType, handler: Callable) -> None:
        """イベントハンドラーの登録"""
        
    def unsubscribe(self, event_type: EventType, handler: Callable) -> None:
        """イベントハンドラーの登録解除"""
        
    def emit(self, event: Event) -> None:
        """イベントの発行"""
```

## 4. ドメインモデル層（domain）

### 4.1 CelestialBody クラス

```python
from abc import ABC, abstractmethod
from typing import Tuple, Optional
import numpy as np

class CelestialBody(ABC):
    """
    天体の基底クラス
    """
    
    def __init__(self, name: str, mass: float, radius: float):
        self.name: str = name
        self.mass: float = mass  # kg
        self.radius: float = radius  # km
        self.position: np.ndarray = np.zeros(3)  # km
        self.velocity: np.ndarray = np.zeros(3)  # km/s
        
    @abstractmethod
    def update_position(self, julian_date: float) -> None:
        """指定されたユリウス日での位置を計算"""
        pass
        
    @abstractmethod
    def get_visual_properties(self) -> Dict[str, Any]:
        """視覚的プロパティを取得"""
        pass
```

### 4.2 Planet クラス

```python
from dataclasses import dataclass
from typing import Dict, Any, Optional

@dataclass
class OrbitalElements:
    """軌道要素データクラス"""
    semi_major_axis: float      # 軌道長半径 (AU)
    eccentricity: float         # 離心率
    inclination: float          # 軌道傾斜角 (度)
    longitude_of_ascending_node: float  # 昇交点黄経 (度)
    argument_of_perihelion: float      # 近日点引数 (度)
    mean_anomaly_at_epoch: float       # 元期における平均近点角 (度)
    epoch: float                       # 元期 (ユリウス日)

class Planet(CelestialBody):
    """
    惑星クラス
    """
    
    def __init__(self, name: str, mass: float, radius: float, 
                 orbital_elements: OrbitalElements,
                 color: Tuple[float, float, float],
                 texture_path: Optional[str] = None):
        super().__init__(name, mass, radius)
        self.orbital_elements = orbital_elements
        self.color = color
        self.texture_path = texture_path
        self.rotation_period: float = 0.0  # 自転周期（時間）
        self.axial_tilt: float = 0.0      # 自転軸傾斜角（度）
        
    def update_position(self, julian_date: float) -> None:
        """ケプラーの法則に基づいて位置を計算"""
        # 平均近点角の計算
        # 離心近点角の計算（ケプラー方程式）
        # 真近点角の計算
        # 軌道面での位置計算
        # 3次元空間への変換
        
    def get_visual_properties(self) -> Dict[str, Any]:
        """惑星の視覚的プロパティを返す"""
        return {
            'color': self.color,
            'texture_path': self.texture_path,
            'radius': self.radius,
            'rotation_angle': self._calculate_rotation_angle()
        }
```

### 4.3 SolarSystem クラス

```python
from typing import List, Optional, Dict

class SolarSystem:
    """
    太陽系全体を管理するクラス
    """
    
    def __init__(self):
        self.sun: Optional[Sun] = None
        self.planets: Dict[str, Planet] = {}
        self.current_date: float = 0.0  # ユリウス日
        
    def add_celestial_body(self, body: CelestialBody) -> None:
        """天体を太陽系に追加"""
        
    def update_all_positions(self, julian_date: float) -> None:
        """全天体の位置を更新"""
        
    def get_planet_by_name(self, name: str) -> Optional[Planet]:
        """名前で惑星を検索"""
        
    def get_all_bodies(self) -> List[CelestialBody]:
        """全天体のリストを取得"""
```

## 5. シミュレーション層（simulation）

### 5.1 PhysicsEngine クラス

```python
import numpy as np
from typing import List, Tuple

class PhysicsEngine:
    """
    物理シミュレーションエンジン
    """
    
    def __init__(self):
        self.gravitational_constant: float = 6.67430e-11  # m^3 kg^-1 s^-2
        self.au_to_km: float = 149597870.7
        
    def calculate_gravitational_force(self, 
                                    body1: CelestialBody, 
                                    body2: CelestialBody) -> np.ndarray:
        """2天体間の重力を計算"""
        
    def integrate_motion(self, 
                        bodies: List[CelestialBody], 
                        dt: float) -> None:
        """運動方程式の数値積分（4次ルンゲ・クッタ法）"""
        
    def solve_kepler_equation(self, 
                            mean_anomaly: float, 
                            eccentricity: float) -> float:
        """ケプラー方程式を解いて離心近点角を求める"""
        # ニュートン・ラフソン法で数値的に解く
```

### 5.2 TimeManager クラス

```python
from datetime import datetime
from typing import Optional

class TimeManager:
    """
    シミュレーション時間を管理するクラス
    """
    
    def __init__(self):
        self.current_julian_date: float = 0.0
        self.time_scale: float = 1.0  # 時間倍率
        self.is_paused: bool = False
        self.epoch_j2000: float = 2451545.0  # J2000.0
        
    def set_date(self, date: datetime) -> None:
        """日時をセット"""
        
    def datetime_to_julian(self, dt: datetime) -> float:
        """datetime をユリウス日に変換"""
        
    def julian_to_datetime(self, jd: float) -> datetime:
        """ユリウス日を datetime に変換"""
        
    def update(self, dt: float) -> None:
        """時間を進める（dt は実時間の秒数）"""
        
    def set_time_scale(self, scale: float) -> None:
        """時間倍率を設定"""
        
    def pause(self) -> None:
        """シミュレーションを一時停止"""
        
    def resume(self) -> None:
        """シミュレーションを再開"""
```

## 6. 可視化層（visualization）

### 6.1 Renderer3D クラス

```python
from vispy import scene
from typing import Dict, Optional, Tuple

class Renderer3D:
    """
    3Dシーンのレンダリングを管理するクラス
    """
    
    def __init__(self, canvas: scene.SceneCanvas):
        self.canvas = canvas
        self.view = canvas.central_widget.add_view()
        self.scene_manager: SceneManager = SceneManager(self.view)
        self.camera_controller: CameraController = CameraController(self.view)
        self.planet_renderers: Dict[str, PlanetRenderer] = {}
        
    def initialize_scene(self) -> None:
        """シーンの初期設定"""
        # 背景色の設定
        # ライティングの設定
        # 座標系の設定
        
    def add_planet(self, planet: Planet) -> None:
        """惑星をシーンに追加"""
        
    def update_planet_position(self, name: str, position: np.ndarray) -> None:
        """惑星の位置を更新"""
        
    def pick_object(self, x: int, y: int) -> Optional[str]:
        """画面座標から3Dオブジェクトを選択"""
        # レイキャスティングで交差判定
        
    def render(self) -> None:
        """シーンをレンダリング"""
```

### 6.2 Camera クラス

```python
import numpy as np
from typing import Tuple

class CameraController:
    """
    3Dカメラの制御クラス
    """
    
    def __init__(self, view):
        self.view = view
        self.camera = scene.TurntableCamera(
            elevation=30,
            azimuth=30,
            fov=60,
            distance=1000
        )
        self.view.camera = self.camera
        
    def rotate(self, delta_azimuth: float, delta_elevation: float) -> None:
        """カメラを回転"""
        
    def zoom(self, factor: float) -> None:
        """ズームイン/アウト"""
        
    def pan(self, delta_x: float, delta_y: float) -> None:
        """カメラを平行移動"""
        
    def focus_on_planet(self, position: np.ndarray, distance: float) -> None:
        """特定の惑星にフォーカス"""
        
    def reset_view(self) -> None:
        """カメラを初期位置にリセット"""
```

### 6.3 PlanetRenderer クラス

```python
from vispy import scene
from typing import Optional, Tuple

class PlanetRenderer:
    """
    個別の惑星をレンダリングするクラス
    """
    
    def __init__(self, planet: Planet, parent: scene.Node):
        self.planet = planet
        self.parent = parent
        self.sphere_visual: Optional[scene.visuals.Sphere] = None
        self.orbit_visual: Optional[scene.visuals.Line] = None
        self.label_visual: Optional[scene.visuals.Text] = None
        self._create_visuals()
        
    def _create_visuals(self) -> None:
        """惑星の視覚要素を作成"""
        # 球体メッシュの作成
        # テクスチャの適用
        # 軌道線の作成（オプション）
        # ラベルの作成
        
    def update_position(self, position: np.ndarray) -> None:
        """惑星の位置を更新"""
        
    def update_rotation(self, angle: float) -> None:
        """惑星の自転角度を更新"""
        
    def set_selected(self, selected: bool) -> None:
        """選択状態の表示"""
        
    def show_orbit(self, show: bool) -> None:
        """軌道線の表示/非表示"""
```

## 7. UI層（ui）

### 7.1 MainWindow クラス

```python
from PyQt6.QtWidgets import QMainWindow, QWidget, QHBoxLayout, QVBoxLayout
from PyQt6.QtCore import Qt
from typing import Optional

class MainWindow(QMainWindow):
    """
    アプリケーションのメインウィンドウ
    """
    
    def __init__(self, app_context: Application):
        super().__init__()
        self.app_context = app_context
        self.control_panel: Optional[ControlPanel] = None
        self.info_panel: Optional[InfoPanel] = None
        self.vispy_widget: Optional[QWidget] = None
        self._init_ui()
        
    def _init_ui(self) -> None:
        """UIの初期化"""
        # ウィンドウ設定
        # レイアウト作成
        # 各パネルの配置
        # メニューバーの作成
        # ツールバーの作成
        
    def _create_menu_bar(self) -> None:
        """メニューバーの作成"""
        # ファイルメニュー
        # 表示メニュー
        # シミュレーションメニュー
        # ヘルプメニュー
        
    def closeEvent(self, event) -> None:
        """ウィンドウクローズイベント"""
```

### 7.2 ControlPanel クラス

```python
from PyQt6.QtWidgets import QWidget, QVBoxLayout, QPushButton, QSlider
from PyQt6.QtCore import pyqtSignal

class ControlPanel(QWidget):
    """
    シミュレーション制御パネル
    """
    
    # シグナル定義
    play_pause_clicked = pyqtSignal()
    time_scale_changed = pyqtSignal(float)
    reset_view_clicked = pyqtSignal()
    
    def __init__(self):
        super().__init__()
        self.time_control: Optional[TimeControl] = None
        self.view_control: Optional[ViewControl] = None
        self.display_options: Optional[DisplayOptions] = None
        self._init_ui()
        
    def _init_ui(self) -> None:
        """UIコンポーネントの初期化"""
        # 時間制御セクション
        # 視点制御セクション
        # 表示オプションセクション
        
    def update_time_display(self, datetime_str: str) -> None:
        """現在時刻の表示を更新"""
```

### 7.3 InfoPanel クラス

```python
from PyQt6.QtWidgets import QWidget, QTextBrowser, QLabel
from typing import Optional, Dict, Any

class InfoPanel(QWidget):
    """
    惑星情報表示パネル
    """
    
    def __init__(self):
        super().__init__()
        self.planet_name_label: Optional[QLabel] = None
        self.info_browser: Optional[QTextBrowser] = None
        self._init_ui()
        
    def _init_ui(self) -> None:
        """UIの初期化"""
        # 惑星名ラベル
        # 情報表示エリア
        # スタイル設定
        
    def display_planet_info(self, planet_data: Dict[str, Any]) -> None:
        """惑星情報を表示"""
        # HTMLフォーマットで整形
        # 各種データの表示
        
    def clear_info(self) -> None:
        """情報をクリア"""
```

## 8. データ層（data）

### 8.1 PlanetRepository クラス

```python
import json
from typing import List, Dict, Any
from pathlib import Path

class PlanetRepository:
    """
    惑星データの永続化を管理するクラス
    """
    
    def __init__(self, data_path: Path):
        self.data_path = data_path
        self._planet_data: Dict[str, Any] = {}
        self._load_data()
        
    def _load_data(self) -> None:
        """JSONファイルからデータを読み込み"""
        
    def get_all_planets(self) -> List[Dict[str, Any]]:
        """全惑星データを取得"""
        
    def get_planet_by_name(self, name: str) -> Optional[Dict[str, Any]]:
        """名前で惑星データを取得"""
        
    def save_custom_data(self, data: Dict[str, Any]) -> None:
        """カスタムデータを保存"""
```

### 8.2 ConfigManager クラス

```python
import json
from pathlib import Path
from typing import Dict, Any

class ConfigManager:
    """
    アプリケーション設定を管理するクラス
    """
    
    def __init__(self, config_path: Path):
        self.config_path = config_path
        self._config: Dict[str, Any] = {}
        self._load_config()
        
    def _load_config(self) -> None:
        """設定ファイルを読み込み"""
        
    def get(self, key: str, default: Any = None) -> Any:
        """設定値を取得"""
        
    def set(self, key: str, value: Any) -> None:
        """設定値を更新"""
        
    def save(self) -> None:
        """設定をファイルに保存"""
```

## 9. エラー処理とロギング

### 9.1 例外クラス

```python
class AstroSimException(Exception):
    """AstroSim基底例外クラス"""
    pass

class DataLoadException(AstroSimException):
    """データ読み込みエラー"""
    pass

class RenderingException(AstroSimException):
    """レンダリングエラー"""
    pass

class SimulationException(AstroSimException):
    """シミュレーションエラー"""
    pass
```

### 9.2 ロギング設定

```python
import logging
from pathlib import Path

def setup_logging(log_dir: Path) -> None:
    """ロギングの設定"""
    
    # ログフォーマット
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    
    # ファイルハンドラー
    file_handler = logging.FileHandler(log_dir / 'astrosim.log', encoding='utf-8')
    file_handler.setFormatter(formatter)
    
    # コンソールハンドラー
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(formatter)
    
    # ルートロガーの設定
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    root_logger.addHandler(file_handler)
    root_logger.addHandler(console_handler)
```

## 10. パフォーマンス最適化

### 10.1 最適化戦略

1. **NumPy ベクトル化**
   - 全ての座標計算をNumPy配列で実行
   - ループの最小化

2. **GPU活用（Vispy）**
   - 頂点バッファオブジェクト（VBO）の使用
   - インスタンシングによる大量オブジェクトの描画

3. **LOD（Level of Detail）**
   - カメラ距離に応じた描画詳細度の調整
   - 遠距離の惑星は簡略化表示

4. **空間分割**
   - Octreeによる効率的な衝突判定
   - 視錐台カリングの実装

### 10.2 メモリ管理

1. **リソースプール**
   - テクスチャのキャッシュ
   - メッシュデータの共有

2. **遅延読み込み**
   - 必要時にのみテクスチャをロード
   - 未使用リソースの自動解放

## 11. セキュリティ考慮事項

1. **入力検証**
   - ファイルパスのサニタイズ
   - 数値範囲のチェック

2. **設定ファイル**
   - JSONスキーマによる検証
   - 不正な値のフォールバック

## 12. 今後の拡張ポイント

1. **プラグインインターフェース**
   ```python
   class PluginInterface(ABC):
       @abstractmethod
       def initialize(self, context: Application) -> None:
           pass
           
       @abstractmethod
       def on_update(self, dt: float) -> None:
           pass
   ```

2. **カスタムシェーダー**
   - GLSL シェーダーの動的読み込み
   - エフェクトシステムの追加

3. **データ形式の拡張**
   - NASA JPL Horizons API との連携
   - リアルタイムデータの取得

本詳細設計書は、実装フェーズでの参照ドキュメントとして使用されます。実装中に発見された問題や変更は、適宜本書に反映されるものとします。